<html>

<body>
  <h1>管理画面</h1>

  <!---
  <button id="refreshButton" type="button">IP更新</button>
  <p>IP指定</p>
  <select id="targetIP">
  </select>
  --->

  <h2> 一般用</h2>
  <h3>1:お化け屋敷に入る前</h3>
  迷ったどうしよ笑<br>
  なんか手術室みたいなところにいる
  <input class="sendChat point1" id="sendPoint1" type="submit" />

  <h3>2:お化け屋敷に入った直後</h3>
  ドア開かない<br>
  待って閉じ込められた
  <input class="sendChat point2" id="sendPoint2" type="submit" />

  <h3>3:手術室に入る前</h3>
  子供に鍵を奪われた<br>
  うでも
  <input class="sendChat point3" id="sendPoint3" type="submit" />

  <h3>4:謎解きが終わり、手術室を出たあと</h3>
  (画面に1秒だけ画像出現)<br>
  うしろ
  <input class="sendChat point4" id="sendPoint4" type="submit" />

  <h3>5:お化け屋敷から脱出したあと</h3>
  たすけて<br>
  (2秒後)どうしておいてくの<br>
  (1秒おき5回)いかないで
  <input class="sendChat point5" id="sendPoint5" type="submit" />







  <p><b>--------------------------------------------</b></p>
  <h2>デバック用機能</h2>
  <h3>画像送信</h3>
  <input type="file" id="imageFile" accept="image/*" />
  <input id="sendImage" type="submit" />

  <script src="/socket.io/socket.io.js"></script>

  <h2>メッセージ入力</h2>
  <textarea id="inputText" type="text"></textarea>
  <input id="sendButton" type="submit">


  <h2>定型文送信</h2>
  <div>
    <label class="Template1" id="Template1">私、今手術っぽい所にいるけど今どこらへん？待ってるよ〜</label>
    <input class="sendTemplate Template1" id="sendTemp1" type="submit" />

  </div>

  <div>
    <label class="Template2" id="Template2">テンプレ2</label>
    <input class="sendTemplate Template2" id="sendTemp2" type="submit" />
  </div>


  <h2> その他機能</h2>

  <input class="sendAction" id="surprise" type="submit" value="驚かし" />
  <input class="sendAction" id="clear" type="submit" value="初期化" />

  <input class="sendAction" id="kiosk" type="submit" value="kiosk" />


  <script>
    const socket = io();

    //現状は未使用
    const id = "";
    // https://www.sejuku.net/blog/24629
    function sleep(waitSec, callbackFunc) {

      var spanedSec = 0;

      var waitFunc = function () {

        spanedSec++;

        if (spanedSec >= waitSec) {
          if (callbackFunc) callbackFunc();
          return;
        }

        clearTimeout(id);
        id = setTimeout(waitFunc, 1000);

      };

      var id = setTimeout(waitFunc, 1000);

    }


    const addtargetList = (ip) => {
      let data = JSON.parse(ip);
      for (let key in data) {
        const sct = document.getElementById("targetIP");
        const op = document.createElement('option');
        op.value = data[key];
        op.text = key;
        sct.appendChild(op);
      }
    };

    //  document.getElementById("kiosk").addEventListener('click', () => {socket.emit("sendAction", id,"kiosk")});

    actionList = document.getElementsByClassName("sendAction")
    for (let i = 0; i < actionList.length; i++) {
      actionList[i].addEventListener('click', sendAction);
    }

    function sendAction(element) {
      v = element.srcElement.id
      socket.emit("sendAction", id, v)
    }

    // point1
    document.getElementById("sendPoint1").addEventListener('click', () => {
      msg = "迷ったどうしよ笑\nなんか手術室みたいなところにいる";
      socket.emit("sendMessage", id, msg);
    });

    // point2
    document.getElementById("sendPoint2").addEventListener('click', () => {
      msg = "ドア開かない\n待って閉じ込められた";
      socket.emit("sendMessage", id, msg);
    });

    // point3
    document.getElementById("sendPoint3").addEventListener('click', () => {
      msg = "子供に鍵を奪われた\nうでも";
      socket.emit("sendMessage", id, msg);
    });

    // point4
    document.getElementById("sendPoint4").addEventListener('click', () => {

      socket.emit("sendAction", id, "surprise");
      sleep(4, () => {
        msg = "うしろ";
        socket.emit("sendMessage", id, msg);
        socket.emit("sendAction");
      });
    });

    // point3
    document.getElementById("sendPoint5").addEventListener('click', () => {
      msg = "たすけてよ";
      socket.emit("sendMessage", id, msg);

      sleep(2, () => {
        msg = "どうしておいてくの";
        socket.emit("sendMessage", id, msg);

        for (let i = 0; i < 5; i++) {
          sleep(i, () => {
            msg = "いかないで";
            socket.emit("sendMessage", id, msg);
          })
        }
      });

    });


    //send Template
    sendTemplateList = document.getElementsByClassName("sendTemplate");
    for (let i = 0; i < sendTemplateList.length; i++) {
      sendTemplateList[i].addEventListener('click', sendTemplate);
    }
    function sendTemplate(element) {
      classes = element.srcElement.className.split(" ");
      message = document.getElementById(classes[1]).innerHTML;
      socket.emit('sendMessage', id, message);
    }

    //send image
    // https://stackoverflow.com/questions/6150289/how-can-i-convert-an-image-into-base64-string-using-javascript
    function encodeImageFileAsURL(element) {
      //const id = document.getElementById("targetIP").value;
      var file = document.getElementById('imageFile').files[0];
      var reader = new FileReader();
      reader.onloadend = function () {
        socket.emit('sendImage', id, reader.result);
        document.getElementById('imageFile').value = "";
      }
      reader.readAsDataURL(file);
    }

    document.getElementById('sendImage').addEventListener('click', encodeImageFileAsURL);



    //send message
    document.getElementById('sendButton').addEventListener('click', () => {

      // inputに入力されたテキストを取得
      let inputMessage = document.getElementById('inputText').value;

      if (inputMessage === '') {
        return;
      }

      //id = document.getElementById("targetIP").value;

      // 'sendMessage' イベントを発火、メッセージを送信
      socket.emit('sendMessage', id, inputMessage);

      // input 内のテキストを空にする
      document.getElementById('inputText').value = "";
    });

    //refresh ip
    /*
    document.getElementById("refreshButton").addEventListener('click', () => {
      socket.emit('RequestIPList');
    });
    */

    socket.on("receiveIP", (ipJson) => {
      const sct = document.getElementById("targetIP");
      sct.innerText = "";
      addtargetList(ipJson);
    });
  </script>
</body>

</html>
